
@app.command()
def run(
    repo: str = typer.Option(..., help="Repository in format 'owner/repo'"),
    issue: int = typer.Option(..., help="Issue ID to triage"),
    rules: str = typer.Option("rules.yaml", help="Path to rules configuration"),
    apply: bool = typer.Option(False, "--apply", help="Actually apply labels and comments to GitHub"),
    yes: bool = typer.Option(False, "--yes", "-y", help="Skip confirmation prompt")
):
    """
    Production Mode: Fetch -> Extract -> Decide -> Applied.
    """
    from app.services.github_service import GitHubService
    from app.core.config import settings

    # 1. Setup
    with console.status("Initialising..."):
        try:
            gh = GitHubService(github_token=settings.GITHUB_TOKEN)
            extractor = ExtractorService()
            triage = TriageService(rules)
        except Exception as e:
            console.print(f"[red]Setup Error: {e}[/red]")
            raise typer.Exit(code=1)

        if "/" not in repo:
             console.print("[red]Repo must be 'owner/repo'[/red]")
             raise typer.Exit(code=1)
        owner, repo_name = repo.split("/")

    # 2. Fetch
    try:
        with console.status(f"Fetching issue {repo}#{issue}..."):
            gh_issue = asyncio.run(gh.fetch_issue(owner, repo_name, issue))
    except Exception as e:
        console.print(f"[red]Fetch Failed: {e}[/red]")
        raise typer.Exit(code=1)

    # 3. Extract
    text_content = f"Title: {gh_issue.title}\n\nBody:\n{gh_issue.body}\n\nComments:\n" + "\n".join(gh_issue.comments)
    
    with console.status("Analysing..."):
        metadata = asyncio.run(extractor.extract(text_content))

    # 4. Decide
    action = triage.evaluate(metadata)

    # 5. Report
    console.print(Panel(f"Analysis for {repo}#{issue}", style="bold green"))
    
    # Show Summary Table
    table = Table(show_header=True, header_style="bold magenta")
    table.add_column("Metric")
    table.add_column("Result")
    
    table.add_row("Confidence", f"{metadata.extraction_confidence:.2f}")
    table.add_row("Recommended Priority", str(action.priority_score))
    table.add_row("Recommended Labels", ", ".join(action.labels))
    
    console.print(table)
    console.print(f"[italic]{action.reasoning}[/italic]")

    # 6. Apply
    if apply:
        if not yes:
            confirm = typer.confirm("Do you want to apply these changes to GitHub?")
            if not confirm:
                console.print("[yellow]Aborted.[/yellow]")
                raise typer.Exit()
        
        with console.status("Applying to GitHub..."):
            success = asyncio.run(gh.apply_labels(owner, repo_name, issue, action.labels))
            
            if success:
                console.print("[bold green]✔ Labels applied![/bold green]")
                
                # Optional: Comment logic could go here
                comment_body = f"**[AI Triage]**\n\nPriority: P{action.priority_score}\nReasoning: {action.reasoning}"
                # asyncio.run(gh.post_comment(owner, repo_name, issue, comment_body))
            else:
                console.print("[bold red]✘ Failed to apply changes.[/bold red]")
    else:
        console.print("\n[dim]Dry run complete. Use --apply to execute changes.[/dim]")
